Describe "Connect-SagaGraph Unit Tests" -Tag "Unit" {
    BeforeDiscovery {        
        $testCasesAuthFlow = @(
            @{
                GraphMethod = 'DeviceCode'
            }
            @{
                GraphMethod    = 'Certificate'
                ParameterName  = 'Certificate'
                ParameterValue = [System.Security.Cryptography.X509Certificates.X509Certificate2]::new( # lol
                    [byte[]]@(
                        48
                        130
                        9
                        194
                        2
                        1
                        3
                        48
                        130
                        9
                        126
                        6
                        9
                        42
                        134
                        72
                        134
                        247
                        13
                        1
                        7
                        1
                        160
                        130
                        9
                        111
                        4
                        130
                        9
                        107
                        48
                        130
                        9
                        103
                        48
                        130
                        5
                        240
                        6
                        9
                        42
                        134
                        72
                        134
                        247
                        13
                        1
                        7
                        1
                        160
                        130
                        5
                        225
                        4
                        130
                        5
                        221
                        48
                        130
                        5
                        217
                        48
                        130
                        5
                        213
                        6
                        11
                        42
                        134
                        72
                        134
                        247
                        13
                        1
                        12
                        10
                        1
                        2
                        160
                        130
                        4
                        238
                        48
                        130
                        4
                        234
                        48
                        28
                        6
                        10
                        42
                        134
                        72
                        134
                        247
                        13
                        1
                        12
                        1
                        3
                        48
                        14
                        4
                        8
                        215
                        42
                        32
                        179
                        201
                        81
                        203
                        157
                        2
                        2
                        7
                        208
                        4
                        130
                        4
                        200
                        45
                        203
                        114
                        15
                        122
                        111
                        150
                        10
                        119
                        234
                        232
                        36
                        217
                        62
                        231
                        12
                        28
                        207
                        86
                        215
                        217
                        74
                        193
                        114
                        27
                        205
                        167
                        126
                        167
                        175
                        25
                        206
                        190
                        116
                        115
                        92
                        108
                        95
                        155
                        202
                        156
                        151
                        126
                        86
                        200
                        134
                        220
                        139
                        237
                        165
                        245
                        191
                        48
                        164
                        219
                        8
                        79
                        187
                        79
                        73
                        87
                        179
                        96
                        17
                        73
                        181
                        94
                        246
                        19
                        179
                        56
                        46
                        32
                        65
                        212
                        68
                        125
                        26
                        239
                        223
                        162
                        155
                        186
                        62
                        130
                        134
                        210
                        64
                        141
                        182
                        65
                        122
                        93
                        218
                        237
                        126
                        18
                        200
                        80
                        241
                        89
                        154
                        217
                        89
                        114
                        7
                        236
                        200
                        30
                        202
                        247
                        85
                        63
                        111
                        112
                        49
                        229
                        26
                        103
                        94
                        215
                        54
                        115
                        66
                        64
                        236
                        188
                        22
                        142
                        97
                        58
                        51
                        95
                        105
                        68
                        157
                        252
                        246
                        16
                        237
                        45
                        185
                        133
                        218
                        199
                        252
                        207
                        234
                        54
                        227
                        34
                        196
                        85
                        186
                        152
                        25
                        138
                        8
                        243
                        240
                        92
                        85
                        96
                        243
                        181
                        95
                        124
                        42
                        153
                        4
                        212
                        207
                        56
                        96
                        133
                        159
                        209
                        185
                        49
                        161
                        45
                        239
                        109
                        245
                        231
                        229
                        142
                        243
                        202
                        149
                        89
                        223
                        228
                        186
                        82
                        27
                        129
                        81
                        91
                        184
                        208
                        22
                        173
                        50
                        216
                        169
                        226
                        97
                        140
                        179
                        134
                        209
                        84
                        98
                        77
                        73
                        83
                        95
                        154
                        192
                        171
                        0
                        91
                        55
                        135
                        123
                        13
                        197
                        24
                        60
                        241
                        60
                        28
                        9
                        26
                        46
                        45
                        1
                        212
                        3
                        133
                        132
                        162
                        62
                        213
                        82
                        30
                        205
                        116
                        183
                        232
                        83
                        22
                        247
                        13
                        21
                        191
                        150
                        170
                        115
                        91
                        74
                        104
                        158
                        10
                        116
                        74
                        123
                        129
                        103
                        91
                        145
                        46
                        117
                        197
                        123
                        197
                        65
                        99
                        128
                        52
                        75
                        163
                        130
                        161
                        79
                        169
                        164
                        138
                        187
                        87
                        134
                        56
                        2
                        234
                        56
                        17
                        34
                        218
                        123
                        6
                        74
                        98
                        19
                        214
                        202
                        14
                        241
                        75
                        119
                        191
                        146
                        4
                        169
                        216
                        107
                        146
                        183
                        111
                        251
                        151
                        74
                        106
                        67
                        100
                        33
                        161
                        99
                        211
                        186
                        45
                        42
                        122
                        92
                        119
                        33
                        234
                        186
                        111
                        246
                        80
                        25
                        79
                        164
                        125
                        14
                        43
                        106
                        194
                        7
                        14
                        67
                        91
                        217
                        220
                        4
                        167
                        237
                        126
                        70
                        193
                        230
                        105
                        172
                        180
                        231
                        81
                        241
                        50
                        175
                        207
                        75
                        86
                        229
                        135
                        163
                        184
                        252
                        12
                        252
                        181
                        216
                        37
                        93
                        155
                        33
                        248
                        249
                        202
                        46
                        29
                        64
                        213
                        23
                        240
                        236
                        8
                        223
                        26
                        255
                        209
                        35
                        98
                        234
                        232
                        146
                        195
                        200
                        159
                        90
                        221
                        117
                        3
                        122
                        140
                        17
                        176
                        175
                        250
                        97
                        191
                        171
                        67
                        189
                        225
                        27
                        186
                        15
                        167
                        201
                        237
                        147
                        204
                        141
                        1
                        176
                        105
                        212
                        85
                        134
                        49
                        35
                        87
                        229
                        125
                        221
                        10
                        173
                        142
                        225
                        229
                        254
                        140
                        202
                        81
                        140
                        183
                        203
                        116
                        24
                        219
                        96
                        20
                        122
                        107
                        24
                        212
                        244
                        82
                        129
                        140
                        88
                        98
                        200
                        73
                        237
                        180
                        235
                        193
                        254
                        233
                        70
                        128
                        138
                        54
                        128
                        237
                        190
                        144
                        53
                        244
                        86
                        143
                        126
                        238
                        18
                        155
                        68
                        7
                        138
                        246
                        119
                        253
                        185
                        168
                        5
                        121
                        210
                        253
                        128
                        115
                        216
                        159
                        88
                        152
                        182
                        31
                        255
                        165
                        61
                        33
                        244
                        62
                        12
                        9
                        128
                        36
                        87
                        23
                        66
                        37
                        218
                        22
                        62
                        85
                        82
                        19
                        54
                        231
                        235
                        180
                        103
                        177
                        107
                        159
                        40
                        95
                        22
                        31
                        0
                        54
                        246
                        159
                        125
                        110
                        76
                        70
                        197
                        91
                        118
                        187
                        15
                        180
                        164
                        216
                        147
                        121
                        178
                        114
                        74
                        175
                        58
                        80
                        249
                        84
                        153
                        161
                        1
                        74
                        209
                        227
                        98
                        198
                        221
                        95
                        56
                        13
                        43
                        89
                        185
                        64
                        101
                        198
                        100
                        207
                        251
                        100
                        168
                        30
                        50
                        222
                        130
                        189
                        25
                        32
                        166
                        70
                        34
                        25
                        250
                        182
                        214
                        13
                        52
                        40
                        218
                        123
                        127
                        121
                        252
                        70
                        230
                        218
                        208
                        148
                        88
                        56
                        66
                        166
                        29
                        108
                        104
                        196
                        34
                        202
                        10
                        216
                        200
                        38
                        9
                        110
                        188
                        10
                        90
                        211
                        77
                        228
                        135
                        251
                        214
                        6
                        216
                        58
                        17
                        171
                        181
                        49
                        81
                        146
                        195
                        129
                        247
                        83
                        14
                        26
                        19
                        99
                        109
                        149
                        106
                        250
                        179
                        196
                        143
                        222
                        223
                        179
                        221
                        24
                        186
                        165
                        204
                        121
                        103
                        150
                        223
                        213
                        60
                        59
                        58
                        194
                        158
                        85
                        156
                        122
                        51
                        252
                        88
                        53
                        27
                        70
                        59
                        233
                        160
                        107
                        167
                        61
                        38
                        140
                        255
                        229
                        211
                        47
                        132
                        129
                        29
                        132
                        31
                        115
                        213
                        235
                        209
                        59
                        134
                        202
                        98
                        96
                        136
                        35
                        224
                        63
                        164
                        7
                        184
                        177
                        39
                        163
                        206
                        40
                        235
                        84
                        50
                        71
                        100
                        171
                        68
                        199
                        161
                        144
                        13
                        5
                        99
                        150
                        173
                        209
                        146
                        233
                        218
                        30
                        45
                        63
                        172
                        21
                        99
                        155
                        46
                        60
                        163
                        28
                        97
                        201
                        215
                        83
                        242
                        111
                        201
                        58
                        41
                        97
                        89
                        179
                        120
                        152
                        167
                        55
                        191
                        131
                        67
                        151
                        173
                        40
                        103
                        61
                        8
                        2
                        135
                        72
                        120
                        255
                        70
                        94
                        224
                        67
                        192
                        111
                        89
                        176
                        106
                        167
                        216
                        239
                        200
                        107
                        15
                        233
                        36
                        15
                        116
                        150
                        185
                        186
                        33
                        2
                        149
                        201
                        62
                        26
                        195
                        75
                        193
                        22
                        111
                        3
                        237
                        226
                        16
                        116
                        65
                        116
                        129
                        178
                        38
                        56
                        233
                        75
                        28
                        54
                        174
                        117
                        157
                        177
                        218
                        243
                        163
                        150
                        91
                        145
                        181
                        16
                        161
                        157
                        61
                        97
                        47
                        52
                        208
                        17
                        232
                        71
                        70
                        76
                        66
                        69
                        10
                        2
                        45
                        126
                        123
                        28
                        66
                        166
                        183
                        195
                        152
                        196
                        200
                        98
                        240
                        209
                        152
                        241
                        142
                        120
                        220
                        166
                        68
                        33
                        35
                        98
                        68
                        114
                        111
                        246
                        76
                        240
                        32
                        210
                        230
                        239
                        39
                        162
                        228
                        193
                        207
                        169
                        237
                        184
                        42
                        237
                        77
                        79
                        134
                        68
                        146
                        197
                        45
                        121
                        40
                        188
                        112
                        207
                        37
                        16
                        215
                        41
                        201
                        89
                        56
                        210
                        81
                        189
                        237
                        174
                        154
                        56
                        114
                        153
                        123
                        252
                        12
                        74
                        31
                        195
                        118
                        30
                        186
                        157
                        157
                        77
                        16
                        53
                        136
                        231
                        140
                        188
                        189
                        205
                        235
                        35
                        66
                        62
                        174
                        80
                        98
                        203
                        231
                        9
                        213
                        143
                        56
                        235
                        138
                        1
                        48
                        186
                        63
                        64
                        138
                        244
                        94
                        3
                        172
                        168
                        130
                        40
                        59
                        8
                        2
                        173
                        94
                        185
                        150
                        7
                        124
                        134
                        173
                        209
                        189
                        216
                        199
                        100
                        212
                        155
                        199
                        208
                        234
                        189
                        141
                        145
                        3
                        80
                        111
                        251
                        35
                        172
                        255
                        50
                        70
                        206
                        128
                        198
                        229
                        10
                        195
                        235
                        124
                        177
                        81
                        198
                        166
                        232
                        37
                        190
                        130
                        125
                        127
                        139
                        24
                        138
                        66
                        227
                        128
                        33
                        234
                        209
                        134
                        56
                        125
                        196
                        247
                        16
                        89
                        244
                        250
                        90
                        241
                        185
                        83
                        176
                        44
                        139
                        149
                        210
                        42
                        77
                        134
                        206
                        164
                        135
                        121
                        62
                        29
                        9
                        227
                        5
                        168
                        83
                        99
                        207
                        64
                        74
                        126
                        65
                        75
                        210
                        213
                        64
                        46
                        129
                        55
                        3
                        194
                        133
                        32
                        89
                        38
                        30
                        72
                        57
                        69
                        40
                        190
                        228
                        0
                        38
                        59
                        17
                        215
                        243
                        106
                        80
                        171
                        34
                        185
                        36
                        92
                        189
                        21
                        163
                        11
                        189
                        222
                        216
                        231
                        6
                        129
                        250
                        226
                        37
                        35
                        130
                        136
                        168
                        122
                        235
                        252
                        64
                        22
                        208
                        0
                        18
                        172
                        146
                        136
                        89
                        72
                        70
                        10
                        85
                        248
                        154
                        11
                        21
                        126
                        24
                        4
                        242
                        125
                        115
                        195
                        8
                        72
                        49
                        5
                        164
                        203
                        199
                        18
                        106
                        247
                        61
                        131
                        86
                        39
                        82
                        254
                        83
                        177
                        243
                        191
                        75
                        152
                        16
                        58
                        211
                        151
                        227
                        199
                        44
                        148
                        31
                        206
                        39
                        9
                        208
                        154
                        168
                        60
                        126
                        250
                        180
                        48
                        146
                        210
                        172
                        204
                        79
                        66
                        144
                        77
                        241
                        212
                        220
                        97
                        49
                        129
                        211
                        48
                        19
                        6
                        9
                        42
                        134
                        72
                        134
                        247
                        13
                        1
                        9
                        21
                        49
                        6
                        4
                        4
                        1
                        0
                        0
                        0
                        48
                        93
                        6
                        9
                        42
                        134
                        72
                        134
                        247
                        13
                        1
                        9
                        20
                        49
                        80
                        30
                        78
                        0
                        116
                        0
                        101
                        0
                        45
                        0
                        54
                        0
                        102
                        0
                        51
                        0
                        98
                        0
                        51
                        0
                        48
                        0
                        98
                        0
                        101
                        0
                        45
                        0
                        101
                        0
                        102
                        0
                        50
                        0
                        56
                        0
                        45
                        0
                        52
                        0
                        56
                        0
                        99
                        0
                        48
                        0
                        45
                        0
                        97
                        0
                        97
                        0
                        53
                        0
                        51
                        0
                        45
                        0
                        54
                        0
                        55
                        0
                        101
                        0
                        49
                        0
                        48
                        0
                        57
                        0
                        57
                        0
                        99
                        0
                        100
                        0
                        55
                        0
                        102
                        0
                        98
                        48
                        93
                        6
                        9
                        43
                        6
                        1
                        4
                        1
                        130
                        55
                        17
                        1
                        49
                        80
                        30
                        78
                        0
                        77
                        0
                        105
                        0
                        99
                        0
                        114
                        0
                        111
                        0
                        115
                        0
                        111
                        0
                        102
                        0
                        116
                        0
                        32
                        0
                        83
                        0
                        111
                        0
                        102
                        0
                        116
                        0
                        119
                        0
                        97
                        0
                        114
                        0
                        101
                        0
                        32
                        0
                        75
                        0
                        101
                        0
                        121
                        0
                        32
                        0
                        83
                        0
                        116
                        0
                        111
                        0
                        114
                        0
                        97
                        0
                        103
                        0
                        101
                        0
                        32
                        0
                        80
                        0
                        114
                        0
                        111
                        0
                        118
                        0
                        105
                        0
                        100
                        0
                        101
                        0
                        114
                        48
                        130
                        3
                        111
                        6
                        9
                        42
                        134
                        72
                        134
                        247
                        13
                        1
                        7
                        6
                        160
                        130
                        3
                        96
                        48
                        130
                        3
                        92
                        2
                        1
                        0
                        48
                        130
                        3
                        85
                        6
                        9
                        42
                        134
                        72
                        134
                        247
                        13
                        1
                        7
                        1
                        48
                        28
                        6
                        10
                        42
                        134
                        72
                        134
                        247
                        13
                        1
                        12
                        1
                        3
                        48
                        14
                        4
                        8
                        201
                        90
                        215
                        64
                        6
                        85
                        45
                        230
                        2
                        2
                        7
                        208
                        128
                        130
                        3
                        40
                        142
                        115
                        129
                        240
                        221
                        32
                        148
                        101
                        119
                        35
                        203
                        67
                        186
                        128
                        63
                        226
                        40
                        112
                        104
                        42
                        87
                        218
                        216
                        132
                        182
                        13
                        251
                        97
                        136
                        69
                        196
                        187
                        180
                        157
                        193
                        21
                        16
                        169
                        20
                        206
                        161
                        192
                        251
                        87
                        176
                        56
                        34
                        42
                        252
                        141
                        43
                        250
                        172
                        31
                        108
                        92
                        234
                        109
                        129
                        73
                        42
                        102
                        164
                        48
                        29
                        115
                        41
                        207
                        74
                        32
                        36
                        108
                        234
                        204
                        99
                        135
                        206
                        19
                        216
                        92
                        190
                        234
                        234
                        12
                        208
                        130
                        13
                        249
                        116
                        68
                        16
                        30
                        137
                        115
                        229
                        28
                        204
                        189
                        173
                        54
                        155
                        84
                        150
                        240
                        159
                        55
                        110
                        233
                        72
                        10
                        32
                        76
                        4
                        152
                        154
                        83
                        231
                        158
                        225
                        15
                        40
                        35
                        83
                        230
                        194
                        59
                        148
                        153
                        170
                        169
                        178
                        108
                        157
                        224
                        107
                        53
                        147
                        220
                        69
                        31
                        8
                        179
                        29
                        88
                        161
                        168
                        239
                        235
                        192
                        14
                        144
                        67
                        162
                        247
                        60
                        120
                        166
                        124
                        135
                        170
                        243
                        94
                        227
                        114
                        109
                        255
                        73
                        89
                        254
                        171
                        110
                        216
                        119
                        97
                        241
                        205
                        194
                        52
                        56
                        238
                        41
                        40
                        241
                        54
                        233
                        168
                        164
                        245
                        9
                        122
                        92
                        41
                        203
                        238
                        214
                        6
                        59
                        59
                        184
                        119
                        235
                        85
                        93
                        214
                        54
                        208
                        255
                        1
                        101
                        102
                        38
                        118
                        147
                        89
                        0
                        224
                        31
                        172
                        153
                        10
                        26
                        177
                        47
                        213
                        34
                        219
                        160
                        18
                        165
                        165
                        71
                        62
                        159
                        245
                        169
                        191
                        147
                        12
                        57
                        102
                        155
                        252
                        108
                        172
                        202
                        166
                        235
                        14
                        131
                        38
                        32
                        112
                        248
                        235
                        76
                        192
                        245
                        180
                        164
                        252
                        217
                        241
                        206
                        21
                        136
                        245
                        70
                        118
                        209
                        60
                        255
                        111
                        138
                        130
                        74
                        156
                        95
                        29
                        141
                        13
                        36
                        75
                        123
                        38
                        224
                        131
                        102
                        163
                        164
                        45
                        197
                        181
                        229
                        210
                        255
                        12
                        213
                        149
                        9
                        174
                        112
                        151
                        44
                        106
                        153
                        245
                        197
                        115
                        209
                        190
                        98
                        9
                        229
                        78
                        63
                        190
                        174
                        117
                        18
                        226
                        253
                        185
                        133
                        199
                        27
                        148
                        136
                        207
                        39
                        177
                        107
                        200
                        72
                        107
                        80
                        95
                        30
                        150
                        243
                        123
                        129
                        153
                        203
                        24
                        180
                        106
                        121
                        55
                        77
                        113
                        149
                        83
                        89
                        153
                        154
                        231
                        153
                        12
                        216
                        111
                        187
                        5
                        2
                        41
                        124
                        156
                        245
                        193
                        48
                        149
                        252
                        27
                        134
                        48
                        114
                        220
                        6
                        180
                        115
                        67
                        94
                        1
                        86
                        163
                        226
                        71
                        232
                        45
                        186
                        149
                        5
                        117
                        11
                        207
                        63
                        146
                        188
                        188
                        23
                        86
                        63
                        155
                        0
                        162
                        40
                        168
                        108
                        98
                        55
                        88
                        7
                        156
                        37
                        180
                        235
                        177
                        111
                        18
                        203
                        255
                        225
                        101
                        12
                        120
                        77
                        108
                        118
                        170
                        139
                        207
                        17
                        139
                        208
                        211
                        186
                        32
                        86
                        136
                        209
                        170
                        229
                        150
                        208
                        246
                        241
                        106
                        146
                        197
                        178
                        37
                        189
                        179
                        30
                        97
                        209
                        191
                        160
                        55
                        247
                        62
                        244
                        122
                        184
                        10
                        11
                        101
                        177
                        104
                        7
                        231
                        182
                        9
                        107
                        6
                        232
                        46
                        197
                        133
                        75
                        137
                        82
                        156
                        173
                        212
                        168
                        142
                        132
                        9
                        254
                        194
                        180
                        92
                        176
                        210
                        20
                        150
                        34
                        0
                        227
                        170
                        216
                        58
                        41
                        126
                        136
                        73
                        7
                        100
                        252
                        141
                        151
                        137
                        77
                        66
                        9
                        17
                        145
                        214
                        46
                        136
                        228
                        134
                        75
                        248
                        2
                        171
                        110
                        214
                        198
                        5
                        124
                        51
                        172
                        203
                        17
                        178
                        84
                        204
                        57
                        123
                        166
                        46
                        218
                        163
                        141
                        36
                        232
                        19
                        204
                        205
                        86
                        203
                        220
                        64
                        245
                        134
                        187
                        254
                        238
                        11
                        88
                        162
                        161
                        249
                        40
                        117
                        80
                        38
                        211
                        208
                        3
                        176
                        118
                        229
                        162
                        218
                        75
                        123
                        208
                        28
                        9
                        253
                        246
                        231
                        63
                        37
                        45
                        233
                        94
                        162
                        82
                        152
                        12
                        218
                        191
                        132
                        106
                        144
                        23
                        13
                        22
                        60
                        138
                        95
                        24
                        201
                        245
                        201
                        154
                        249
                        36
                        236
                        128
                        153
                        230
                        185
                        88
                        199
                        16
                        202
                        76
                        123
                        51
                        40
                        240
                        63
                        151
                        182
                        45
                        229
                        37
                        184
                        182
                        254
                        161
                        237
                        70
                        80
                        147
                        212
                        98
                        222
                        242
                        152
                        253
                        18
                        82
                        30
                        128
                        176
                        230
                        239
                        240
                        42
                        35
                        123
                        110
                        168
                        165
                        1
                        160
                        166
                        144
                        225
                        219
                        56
                        166
                        248
                        116
                        79
                        20
                        141
                        18
                        160
                        195
                        246
                        25
                        211
                        187
                        98
                        243
                        117
                        158
                        49
                        148
                        53
                        233
                        67
                        27
                        247
                        15
                        229
                        235
                        53
                        148
                        74
                        188
                        86
                        78
                        226
                        43
                        228
                        191
                        194
                        155
                        225
                        24
                        174
                        205
                        102
                        230
                        97
                        155
                        35
                        197
                        60
                        74
                        118
                        191
                        235
                        226
                        133
                        162
                        34
                        31
                        26
                        180
                        25
                        129
                        152
                        217
                        158
                        127
                        91
                        85
                        155
                        217
                        13
                        229
                        253
                        176
                        176
                        48
                        116
                        234
                        244
                        212
                        146
                        31
                        94
                        56
                        123
                        71
                        214
                        107
                        111
                        48
                        87
                        131
                        221
                        32
                        232
                        34
                        242
                        214
                        55
                        79
                        41
                        190
                        26
                        45
                        190
                        101
                        166
                        130
                        4
                        215
                        43
                        116
                        20
                        180
                        29
                        175
                        236
                        138
                        249
                        71
                        217
                        239
                        160
                        56
                        166
                        213
                        156
                        101
                        79
                        89
                        37
                        144
                        227
                        138
                        160
                        194
                        165
                        14
                        213
                        231
                        213
                        48
                        59
                        48
                        31
                        48
                        7
                        6
                        5
                        43
                        14
                        3
                        2
                        26
                        4
                        20
                        56
                        36
                        166
                        206
                        86
                        11
                        198
                        40
                        242
                        126
                        5
                        146
                        173
                        104
                        203
                        193
                        228
                        151
                        104
                        224
                        4
                        20
                        36
                        14
                        227
                        189
                        17
                        159
                        197
                        67
                        101
                        108
                        85
                        31
                        215
                        35
                        208
                        250
                        75
                        129
                        181
                        56
                        2
                        2
                        7
                        208
                    ),
                    '555nase'
                )
            }
            @{
                GraphMethod = 'Browser'
            }
            @{
                GraphMethod    = 'ClientSecret'
                ParameterName  = 'ClientSecret'
                ParameterValue = [pscredential]::new('na', ('SuperPassword' | ConvertTo-SecureString -AsPlainText -Force))
            }
        )
    }
    BeforeAll {
        # Place here all things needed to prepare for the tests
        Mock -ModuleName shiftavenue.GraphAutomation -MockWith { '982f7129-1c2a-4e66-871f-0c054774892b' } -CommandName Get-PSFConfigValue -ParameterFilter { $FullName -eq 'shiftavenue.GraphAutomation.GraphClientId' }
        Mock -ModuleName shiftavenue.GraphAutomation -MockWith { '982f7129-1c2a-4e66-87f1-0c054774892b' } -CommandName Get-PSFConfigValue -ParameterFilter { $FullName -eq 'shiftavenue.GraphAutomation.GraphTenantId' }
        Mock -ModuleName shiftavenue.GraphAutomation -CommandName Stop-PSFFunction -ParameterFilter { $Message -eq 'Please configure GraphClientId and GraphTenantId' }
        Mock -ModuleName shiftavenue.GraphAutomation -CommandName Get-Module -MockWith { New-Module -Name MiniGraph -ScriptBlock { } }
        Mock -ModuleName shiftavenue.GraphAutomation -CommandName Set-GraphEndpoint
        Mock -ModuleName shiftavenue.GraphAutomation -CommandName Write-PSFMessage
    }
    AfterAll {
        # Here is where all the cleanup tasks go
    }

    Context "Generic Tests" {
        It "Should return an error if the ClientId or TenantId are not set" {
            Mock -ModuleName shiftavenue.GraphAutomation -MockWith { } -CommandName Get-PSFConfigValue -ParameterFilter { $FullName -eq 'shiftavenue.GraphAutomation.GraphClientId' }
            Mock -ModuleName shiftavenue.GraphAutomation -MockWith { } -CommandName Get-PSFConfigValue -ParameterFilter { $FullName -eq 'shiftavenue.GraphAutomation.GraphTenantId' }
        
            { Connect-SagaGraph -ErrorAction Stop } | Should -Throw

            Should -ModuleName shiftavenue.GraphAutomation -Invoke Get-PSFConfigValue -ParameterFilter { $FullName -eq 'shiftavenue.GraphAutomation.GraphClientId' } -Scope It
            Should -ModuleName shiftavenue.GraphAutomation -Invoke Get-PSFConfigValue -ParameterFilter { $FullName -eq 'shiftavenue.GraphAutomation.GraphTenantId' } -Scope It
            Should -ModuleName shiftavenue.GraphAutomation -Invoke Stop-PSFFunction -ParameterFilter { $Message -eq 'Please configure GraphClientId and GraphTenantId' } -Scope It
        }

        It "Should return immediately if already connected" {
            Mock -ModuleName shiftavenue.GraphAutomation -CommandName Get-Module -MockWith { New-Module -Name MiniGraph -ScriptBlock { $script:token = 'abc' } }
            Connect-SagaGraph | Should -ModuleName shiftavenue.GraphAutomation -Not -Invoke Set-GraphEndpoint -Scope It
        }
    }
    
    Context "Auth flows" {
        It "Should call correct method for <GraphMethod>" -ForEach $testCasesAuthFlow {
            if ($ParameterName -and $ParameterValue)
            {
                Mock -ModuleName shiftavenue.GraphAutomation -MockWith { $ParameterValue } -CommandName Get-PSFConfigValue -ParameterFilter { $FullName -eq "shiftavenue.GraphAutomation.Graph$($ParameterName)" }
            }

            Mock -ModuleName shiftavenue.GraphAutomation -CommandName Get-PSFConfigValue -ParameterFilter { $FullName -eq 'shiftavenue.GraphAutomation.GraphConnectionMode' } -MockWith { $GraphMethod }
            Mock -ModuleName shiftavenue.GraphAutomation -CommandName "Connect-Graph$($GraphMethod)" -MockWith { }

            Connect-SagaGraph
            
            Should -ModuleName shiftavenue.GraphAutomation -Invoke "Connect-Graph$($GraphMethod)" -Scope It
            Should -ModuleName shiftavenue.GraphAutomation -Invoke Get-PSFConfigValue -Scope It
            Should -ModuleName shiftavenue.GraphAutomation -Invoke Set-GraphEndpoint -Scope It
        }

        It "Should fail if required value <ParameterName> is missing for <GraphMethod>" -ForEach $testCasesAuthFlow.Where({ $_.ParameterName }) {
            Mock -ModuleName shiftavenue.GraphAutomation -MockWith { } -CommandName Get-PSFConfigValue -ParameterFilter { $FullName -eq "shiftavenue.GraphAutomation.Graph$($ParameterName)" }
            Mock -ModuleName shiftavenue.GraphAutomation -CommandName Get-PSFConfigValue -ParameterFilter { $FullName -eq 'shiftavenue.GraphAutomation.GraphConnectionMode' } -MockWith { $GraphMethod }
            Mock -ModuleName shiftavenue.GraphAutomation -CommandName Stop-PSFFunction -MockWith { } -ParameterFilter { $Message -like "Please configure Graph$($ParameterName)*" }

            { Connect-SagaGraph -ErrorAction Stop } | Should -Throw

            Should -ModuleName shiftavenue.GraphAutomation -Invoke Get-PSFConfigValue -ParameterFilter { $FullName -eq "shiftavenue.GraphAutomation.Graph$($ParameterName)" } -Scope It
            Mock -ModuleName shiftavenue.GraphAutomation -CommandName Get-PSFConfigValue -ParameterFilter { $FullName -eq 'shiftavenue.GraphAutomation.GraphConnectionMode' } -MockWith { $GraphMethod }
        }
    }
}